[
    {
        "title": "$:/plugins/oeyoews/book-status",
        "type": "application/json",
        "text": "{\"tiddlers\":{\"$:/plugins/oeyoews/book-status/readme\":{\"title\":\"$:/plugins/oeyoews/book-status/readme\",\"text\":\"## book status\\n\\n记录你读过的每一个笔记\\n\\n## TODO\\n\\n- [ ] 在每个目录旁边显示是否阅读过, bingo/x\\n- [ ] 获取目录json数据\\n- [x] getstorytiddler\\n- [x] click event\\n- [x] status json\\n- [x] 如何获取每个笔记的书名, 通过sourceTiddler, 或者获取tag, 每本书只有一个tag\\n- [ ] viewtemplate(filter: $:/plugins/books/) 也许可以做成viewtoolbar, 但是不够醒目\\n- [ ] 也许可以借助localstorage当作临时状态(), 最后结束是, 询问是否要保存此次阅读记录, 通知阅读时间\\n- [ ] 支持待看状态\\n- [ ] 每本书一个配置文件, 目前是一个文件\\n\",\"type\":\"text/markdown\",\"description\":\"book-status\"},\"$:/plugins/oeyoews/book-status/mergeObj.js\":{\"title\":\"$:/plugins/oeyoews/book-status/mergeObj.js\",\"text\":\"/*\\\\\\r\\ntitle: $:/plugins/oeyoews/book-status/mergeObj.js\\r\\ntype: application/javascript\\r\\nmodule-type: library\\r\\n\\r\\n\\\\*/\\r\\n// TODO: Object.assign\\r\\nmodule.exports = function mergeObjects(target, ...sources) {\\r\\n  for (const source of sources) {\\r\\n    for (const key in source) {\\r\\n      if (source.hasOwnProperty(key)) {\\r\\n        if (typeof source[key] === 'object' && !Array.isArray(source[key])) {\\r\\n          // 如果属性值是对象，则递归地合并子对象\\r\\n          if (!target.hasOwnProperty(key) || typeof target[key] !== 'object') {\\r\\n            target[key] = {};\\r\\n          }\\r\\n          mergeObjects(target[key], source[key]);\\r\\n        } else {\\r\\n          // 否则直接复制属性值\\r\\n          target[key] = source[key];\\r\\n        }\\r\\n      }\\r\\n    }\\r\\n  }\\r\\n  return target;\\r\\n};\\r\\n\",\"type\":\"application/javascript\",\"module-type\":\"library\"},\"$:/plugins/oeyoews/book-status/tocstatus.js\":{\"title\":\"$:/plugins/oeyoews/book-status/tocstatus.js\",\"text\":\"/*\\\\\\r\\ntitle: $:/plugins/oeyoews/book-status/tocstatus.js\\r\\ntype: application/javascript\\r\\nmodule-type: widget\\r\\n\\r\\n使用wikitext 应该也能做, 但是数据在json里面, 比较麻烦\\r\\n\\\\*/\\r\\nconst { widget: Widget } = require('$:/core/modules/widgets/widget.js');\\r\\n\\r\\nclass BookTocStatusWidget extends Widget {\\r\\n  constructor(parseTreeNode, options) {\\r\\n    super(parseTreeNode, options);\\r\\n  }\\r\\n\\r\\n  render(parent, nextSibling) {\\r\\n    if (!$tw.browser) return;\\r\\n    this.parentDomNode = parent;\\r\\n    this.computeAttributes();\\r\\n    this.execute();\\r\\n\\r\\n    const { bookname = '劫持' } = this.attributes;\\r\\n    const wiki = $tw.wiki;\\r\\n    const createElement = $tw.utils.domMaker;\\r\\n    const statusfilename = 'bookstatus.json';\\r\\n    const statuses = wiki.getTiddlerData(statusfilename);\\r\\n    const pluginname = '$:/plugins/books/' + bookname;\\r\\n    if (!wiki.tiddlerExists(pluginname)) return;\\r\\n    const { tiddlers } = wiki.getPluginInfo(pluginname);\\r\\n    const toc = Object.keys(tiddlers);\\r\\n    const status = statuses[bookname];\\r\\n\\r\\n    const tocStatusData = toc.map((title) => [title, '未读']);\\r\\n    const mergedStatus = Object.assign(tocStatusData, Object.entries(status));\\r\\n    const children = [];\\r\\n\\r\\n    // update status\\r\\n    const createLi = (title, status) => {\\r\\n      const li = this.document.createElement('li');\\r\\n      const color = status === '已读' ? 'green' : 'red';\\r\\n      const content = $tw.wiki.renderText(\\r\\n        'text/html',\\r\\n        'text/vnd.tiddlywiki',\\r\\n        `[[${title}]] <sup>@@color:${color};${status}@@</sup>`,\\r\\n      );\\r\\n      li.innerHTML = content;\\r\\n      children.push(li);\\r\\n      li.addEventListener('click', (e) => {\\r\\n        e.preventDefault();\\r\\n        new $tw.Story().navigateTiddler(title);\\r\\n      });\\r\\n    };\\r\\n\\r\\n    mergedStatus.forEach(([title, status]) => {\\r\\n      createLi(title, status);\\r\\n    });\\r\\n\\r\\n    const domNode = createElement('ol', {\\r\\n      children,\\r\\n    });\\r\\n\\r\\n    parent.insertBefore(domNode, nextSibling);\\r\\n    this.domNodes.push(domNode);\\r\\n  }\\r\\n}\\r\\n\\r\\n/**\\r\\n * @description book-status widget\\r\\n * @param bookname\\r\\n */\\r\\nexports.tocstatus = BookTocStatusWidget;\\r\\n\",\"type\":\"application/javascript\",\"module-type\":\"widget\"},\"$:/plugins/oeyoews/book-status/viewTemplate\":{\"title\":\"$:/plugins/oeyoews/book-status/viewTemplate\",\"tags\":\"$:/tags/ViewTemplate\",\"text\":\"<$list filter=\\\"[all[current]is[shadow]has[bookname]]\\\">\\r\\n  <$bookstatus />\\r\\n</$list>\\r\\n\"},\"$:/plugins/oeyoews/book-status/widget.js\":{\"title\":\"$:/plugins/oeyoews/book-status/widget.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/book-status/widget.js\\ntype: application/javascript\\nmodule-type: widget\\n\\nbook-status widget\\n\\n\\\\*/\\nconst { widget: Widget } = require('$:/core/modules/widgets/widget.js');\\nconst mergeObj = require('./mergeObj');\\n\\nclass BookStatusWidget extends Widget {\\n  static STATUS_UNREAD = '未读';\\n  static STATUS_READ = '已读';\\n\\n  constructor(parseTreeNode, options) {\\n    super(parseTreeNode, options);\\n    this.bookstatusfilename = 'bookstatus.json';\\n    this.statuses = new Map();\\n    this.btn;\\n  }\\n\\n  readStatuses() {\\n    const config = $tw.wiki.getTiddlerData(this.bookstatusfilename) || {};\\n    // json对象转Map\\n    Object.entries(config).forEach(([bookname, book]) => {\\n      Object.entries(book).forEach(([title, status]) => {\\n        const key = `${bookname}/${title}`;\\n        this.statuses.set(key, status);\\n      });\\n    });\\n  }\\n\\n  // 当需要获取某个书籍的阅读状态时，会先从 Map 中查找，如果没有找到则从配置文件中读取数据并进行解析，\\n  // 然后将结果存入 Map 中以备下次使用。\\n  getStatus(bookname, title) {\\n    const key = `${bookname}/${title}`;\\n    if (!this.statuses.has(key)) {\\n      this.readStatuses();\\n    }\\n    return this.statuses.get(key) || '未读';\\n  }\\n\\n  updateStatus(bookname, title) {\\n    this.parentWidget.dispatchEvent({\\n      type: 'om-nprogress',\\n    });\\n    if (title.startsWith('Draft of') || !bookname) return;\\n    const wiki = $tw.wiki;\\n\\n    const defaultconfig = wiki.getTiddlerData(this.bookstatusfilename) || {};\\n    if (!wiki.tiddlerExists(this.bookstatusfilename)) {\\n      wiki.addTiddler({\\n        type: 'application/json',\\n        title: this.bookstatusfilename,\\n        'meta#disabled': 'yes', // disable meta file\\n        text: '',\\n      });\\n    }\\n    const key = `${bookname}/${title}`;\\n    const status = this.getStatus(bookname, title);\\n    const newStatus =\\n      status === BookStatusWidget.STATUS_READ\\n        ? BookStatusWidget.STATUS_UNREAD\\n        : BookStatusWidget.STATUS_READ;\\n    this.statuses.set(key, newStatus);\\n    const obj = {\\n      [bookname]: {\\n        [title]: newStatus,\\n      },\\n    };\\n    mergeObj(defaultconfig, obj);\\n    wiki.setText(\\n      this.bookstatusfilename,\\n      'text',\\n      null,\\n      JSON.stringify(defaultconfig),\\n      {\\n        suppressTimestamp: true,\\n      },\\n    );\\n    this.parentWidget.dispatchEvent({\\n      type: 'om-notify',\\n      paramObject: {\\n        status: newStatus === BookStatusWidget.STATUS_READ ? 'success' : 'info',\\n        title,\\n        text: `更新状态: ${newStatus}`,\\n      },\\n    });\\n    this.btn.removeEventListener('click', () =>\\n      this.updateStatus(bookname, title),\\n    );\\n    this.refreshSelf();\\n    this.parentWidget.dispatchEvent({\\n      type: 'om-nprogress-done',\\n    });\\n  }\\n\\n  render(parent, nextSibling) {\\n    if (!$tw.browser) return;\\n    this.parentDomNode = parent;\\n    this.computeAttributes();\\n    this.execute();\\n\\n    const createElement = $tw.utils.domMaker;\\n    const wiki = $tw.wiki;\\n    const title = this.getVariable('storyTiddler');\\n    const pluginname = wiki.getShadowSource(title);\\n    const { book: bookname } = wiki.getTiddler(pluginname)?.fields || {};\\n    const status = this.getStatus(bookname, title);\\n\\n    const statusClass =\\n      status === BookStatusWidget.STATUS_READ\\n        ? 'text-green-400'\\n        : 'text-rose-400';\\n    this.btn = createElement('button', {\\n      text: status,\\n      class: `p-2 ${statusClass}`,\\n    });\\n\\n    this.btn.addEventListener('click', () =>\\n      this.updateStatus(bookname, title),\\n    );\\n\\n    const domNode = createElement('div', {\\n      class: 'flex justify-end',\\n      children: [this.btn],\\n    });\\n\\n    parent.insertBefore(domNode, nextSibling);\\n    this.domNodes.push(domNode);\\n  }\\n}\\n\\n/**\\n * @description book-status widget\\n * @param configfilename\\n */\\nexports.bookstatus = BookStatusWidget;\\n\",\"type\":\"application/javascript\",\"module-type\":\"widget\"}}}",
        "description": "book-status",
        "author": "oeyoews",
        "version": "0.0.3",
        "core-version": ">=5.3.1",
        "plugin-type": "plugin",
        "name": "book-status",
        "meat#disabled": "yes",
        "dependents": "$:/plugins/oeyoews/tiddlywiki-tailwindcss-plus $:/plugins/oeyoews/notify $:/plugins/oeyoews/nprogress",
        "list": "readme"
    }
]